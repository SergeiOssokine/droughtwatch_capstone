
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../training_pipeline/">
      
      
        <link rel="next" href="../../python_docs/python_docs_training/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.31">
    
    
      
        <title>Inference pipeline in detail - Droughtwatch Capstone Project</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3cba04c6.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#the-inference-pipeline" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Droughtwatch Capstone Project" class="md-header__button md-logo" aria-label="Droughtwatch Capstone Project" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Droughtwatch Capstone Project
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Inference pipeline in detail
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Droughtwatch Capstone Project" class="md-nav__button md-logo" aria-label="Droughtwatch Capstone Project" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Droughtwatch Capstone Project
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    User Guide
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../user_guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    User Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../training_pipeline/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Training pipeline in detail
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Inference pipeline in detail
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Inference pipeline in detail
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#running-inference-on-new-data" class="md-nav__link">
    <span class="md-ellipsis">
      Running inference on new data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#observability" class="md-nav__link">
    <span class="md-ellipsis">
      Observability
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Python API
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Python API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python_docs/python_docs_training/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Training module
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python_docs/python_docs_inference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Inference module
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#running-inference-on-new-data" class="md-nav__link">
    <span class="md-ellipsis">
      Running inference on new data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#observability" class="md-nav__link">
    <span class="md-ellipsis">
      Observability
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="the-inference-pipeline">The inference pipeline</h1>
<h2 id="overview">Overview</h2>
<p>Since in this project we are focusing on satellite data, we choose the batch model of inference, where new data will be placed in a particular location (concretely on AWS S3) and the pipeline is run on a certain cadence to process new images. There's no need for asynchronous or streaming inference here and this keeps costs down.</p>
<p>The inference pipeline is run on the AWS cloud and is orchestrated via <a href="https://aws.amazon.com/step-functions/">AWS StepFunctions</a>. StepFunctions are a robust and easy-to-use tool to build workflows. They feature a graphical editor that can be used to construct workflows, as well as a custom, json-like DSL for a more programmatic approach. The workflow is represented in terms of a state-machine where every node represents a state (e.g. task or choice) and every edge represents a transformation from one state to another. The schematic of the pipeline can be seen below:</p>
<p><img alt="" src="../imgs/state_machine.png" /></p>
<p>The three tasks here are, of course:</p>
<ul>
<li>Processing: turn raw data into processed data ready to be used for the model. This reuses the <a href="https://github.com/SergeiOssokine/droughtwatch_capstone/blob/main/training/airflow/includes/parse_data.py">same code</a> that was used for this purpose in the training pipeline. Additionally, this time every image in every file is given a unique uuid which are stored inside the TFRecords  file.</li>
<li>Inference: the model is loaded and is run on the data to produce predictions for the label of every image. The predictions are written to a parquet file, storing the unique ID and the prediction class for every image.</li>
<li>Observe: a set of metrics looking at the behaviour of the model is computed using <code>Evidently</code>:<ol>
<li>The class distribution (i.e., what share of all the predictions fall in each class).</li>
<li>The prediction drift: a measure of the difference between the distribution of predictions classes on the new data vs the distribution on the training data (as measured by the data drift algorithm)(https://docs.evidentlyai.com/reference/data-drift-algorithm).(note: for simplicity we used synthetic reference data in this project that simply reflects the true underlying class distribution of the data).</li>
</ol>
</li>
</ul>
<p>Each task is followed by a choice node, which checks the output of the task. Depending on the task's success or failure it continues along the graph to the correct next step. In the above, all successful executions take the <em>right</em> branch.</p>
<h2 id="implementation">Implementation</h2>
<p>On a more concrete implementation level, the three tasks above are done by three AWS Lambda functions:</p>
<p><img alt="" src="../imgs/state_machine_impl.png" /></p>
<p>The <a href="https://github.com/SergeiOssokine/droughtwatch_capstone/tree/main/inference/setup">code</a> for the three functions are all packaged in a single Docker image and the correct handler is chosen as appropriate.</p>
<p>The Lambda functions need access to several other AWS services:</p>
<ul>
<li>AWS Elastic Container Registry (ECR): This stores the actual image used by the Lambda functions.</li>
<li>
<p>AWS S3:</p>
<ol>
<li>A model bucket stores the model that we uploaded to S3 at the end of the training pipeline.</li>
<li>A bucket for new inference data stores incoming data and writes the processed data results and predictions.</li>
</ol>
</li>
<li>
<p>AWS Relational Database Service (RDS) where a PostgreSQL database is used for two tasks:</p>
<ol>
<li>Keeping track of which tasks have been completed on which files, in the <code>ledger</code> table. This ensures that only new data is processed and thus no resources are wasted.</li>
<li>Recording a set of metrics in the <code>metrics</code> table, computed with <code>Evidently</code>. These metrics are subsequently visualised in a dashboard. See <a href="#observability">below</a>.</li>
</ol>
</li>
<li>
<p>AWS Secrets Manager: Since we are connecting to RDS, we need to securely store credentials.</p>
</li>
</ul>
<p>In order to schedule the execution of the AWS StepFunction state machine, we use AWS EventBridge scheduler, which is basically just a CRON job that runs on a given cadence. By default, this is 24 hours.</p>
<p>Finally, for the observability dashboard, we elect to run a local <code>Grafana</code> server in <code>Docker</code>. In order for this server to be able to access the data in the AWS RDS database, we set up an EC2 instance in the same network as RDS and create an ssh tunnel to forward the information.</p>
<p>Thus, the complete system looks as follows:</p>
<p><img alt="" src="../imgs/architecture.svg" /></p>
<p>To provision these resources, we use Terraform (both for AWS resources <em>and</em> the local Grafana dashboard). The necessary variables are all configured automatically with <code>setup_inference_infra</code>, except for sensitive values (the database credentials and ssh key for ssh tunnel connection). You can find the Terraform infrastructure <a href="https://github.com/SergeiOssokine/droughtwatch_capstone/tree/main/inference/setup/tf">here</a> for AWS resources in the inference step, and <a href="https://github.com/SergeiOssokine/droughtwatch_capstone/tree/main/inference/observability/tf">here</a> for local <code>Grafana</code>/<code>Docker</code> resources in the observability step. A complete, automatically-generated list of all AWS resources, can be found <a href="../tf_aws/">here</a>.</p>
<h3 id="running-inference-on-new-data">Running inference on new data</h3>
<p>As mentioned in the user guide, you can automatically upload some new data sets to S3 and trigger the pipeline on each by using:</p>
<p><div class="highlight"><pre><span></span><code>make<span class="w"> </span>upload_and_run_inference
</code></pre></div>
You can follow along with the execution by heading to the <a href="https://console.aws.amazon.com/states/home">AWS CloudConsole</a> in the StepFunctions service, where you should see the <code>droughtwatch-inference</code> state machine. Clicking it will show a list of executions. Clicking on one which is still running will show you a live step-by-step progress of the pipeline, along with convenient links to AWS CloudWatch logs of the Lambda function executions. If all goes well, you should see things proceed as follows:</p>
<p><img alt="" src="../imgs/statemachine.gif" /></p>
<p>Every step of the pipeline can be monitored, and if a particular step fails, one receives a message with the traceback. An example (triggered purposefully) can be seen below:</p>
<p><img alt="" src="../imgs/inference_fail.png" /></p>
<h3 id="observability">Observability</h3>
<p>Using the ssh tunnel, the RDS database can be accessed on the local host at the usual port 5432. As discussed in the user guide, the command <code>make setup_inference_observability</code> will ensure everything is ready. Going to <code>http://localhost:3000</code> and logging in with the default credentials (<code>admin:admin</code>), click on <code>Dashboards</code> in the menu and navigate to the the only folder present. Then click on "Model Observability Dashboard". Because the time of execution is not known in advance, you will have to click "Zoom to data" and you should see something like the following:</p>
<p><img alt="" src="../imgs/grafana_dashboard.png" /></p>
<p>The top two panels show the prediction class distribution and the prediction drift respectively. This gives us an at-a-glance view of how the mode is behaving. The bottom half of the dashboard displays the contents of the ledger table, which shows which data files have been processed and when.</p>
<p>In addition, we have created a Grafana alert, seen here:</p>
<p><img alt="" src="../imgs/grafana_alert.png" /></p>
<p>This alert will trigger if the prediction drift exceeds a threshold of 25%.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
    
  </body>
</html>