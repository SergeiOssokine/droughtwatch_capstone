
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../..">
      
      
        <link rel="next" href="../training_pipeline/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.31">
    
    
      
        <title>User Guide - Droughtwatch Capstone Project</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3cba04c6.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#droughtwatch-capstone-project" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Droughtwatch Capstone Project" class="md-header__button md-logo" aria-label="Droughtwatch Capstone Project" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Droughtwatch Capstone Project
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              User Guide
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/SergeiOssokine/droughtwatch_capstone" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Droughtwatch Capstone Project" class="md-nav__button md-logo" aria-label="Droughtwatch Capstone Project" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Droughtwatch Capstone Project
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/SergeiOssokine/droughtwatch_capstone" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    User Guide
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    User Guide
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    User Guide
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#background-and-problem-statement" class="md-nav__link">
    <span class="md-ellipsis">
      Background and problem statement
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initial-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Initial setup
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Initial setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-the-documentation-optional" class="md-nav__link">
    <span class="md-ellipsis">
      Building the documentation (optional)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#training-the-model" class="md-nav__link">
    <span class="md-ellipsis">
      Training the model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Training the model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#part-i-get-the-data" class="md-nav__link">
    <span class="md-ellipsis">
      Part I: Get the data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-ii-prepare-the-infrastructure" class="md-nav__link">
    <span class="md-ellipsis">
      Part II: Prepare the infrastructure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-iii-training" class="md-nav__link">
    <span class="md-ellipsis">
      Part III: Training
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inference" class="md-nav__link">
    <span class="md-ellipsis">
      Inference
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Inference">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#part-i-setting-up-the-infrastructure" class="md-nav__link">
    <span class="md-ellipsis">
      Part I: Setting up the infrastructure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-ii-running-inference-and-observability" class="md-nav__link">
    <span class="md-ellipsis">
      Part II: Running inference and observability
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    <span class="md-ellipsis">
      Testing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unit-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Unit tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-test" class="md-nav__link">
    <span class="md-ellipsis">
      Integration test
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cicd" class="md-nav__link">
    <span class="md-ellipsis">
      CI/CD
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-quality" class="md-nav__link">
    <span class="md-ellipsis">
      Code quality
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../training_pipeline/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Training pipeline in detail
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../inference_pipeline/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Inference pipeline in detail
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Python API
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Python API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python_docs/python_docs_training/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Training module
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python_docs/python_docs_inference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Inference module
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#background-and-problem-statement" class="md-nav__link">
    <span class="md-ellipsis">
      Background and problem statement
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initial-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Initial setup
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Initial setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-the-documentation-optional" class="md-nav__link">
    <span class="md-ellipsis">
      Building the documentation (optional)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#training-the-model" class="md-nav__link">
    <span class="md-ellipsis">
      Training the model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Training the model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#part-i-get-the-data" class="md-nav__link">
    <span class="md-ellipsis">
      Part I: Get the data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-ii-prepare-the-infrastructure" class="md-nav__link">
    <span class="md-ellipsis">
      Part II: Prepare the infrastructure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-iii-training" class="md-nav__link">
    <span class="md-ellipsis">
      Part III: Training
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inference" class="md-nav__link">
    <span class="md-ellipsis">
      Inference
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Inference">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#part-i-setting-up-the-infrastructure" class="md-nav__link">
    <span class="md-ellipsis">
      Part I: Setting up the infrastructure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-ii-running-inference-and-observability" class="md-nav__link">
    <span class="md-ellipsis">
      Part II: Running inference and observability
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    <span class="md-ellipsis">
      Testing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unit-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Unit tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-test" class="md-nav__link">
    <span class="md-ellipsis">
      Integration test
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cicd" class="md-nav__link">
    <span class="md-ellipsis">
      CI/CD
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-quality" class="md-nav__link">
    <span class="md-ellipsis">
      Code quality
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="droughtwatch-capstone-project">Droughtwatch capstone project</h1>
<h2 id="background-and-problem-statement">Background and problem statement</h2>
<p>With the ever-increasing rate of extreme weather events caused by climate change, it is becoming more and more urgent to be able to predict the impact of these events on agriculture. Severe droughts in particular are one of the most pressing dangers to farmers, bringing the threat of lost crops and food insecurity. Agricultural insurance provides a means to offset some of that risk by offering farmers and pastoralists compensation for lost crops and livestock, but in order to assess the losses and the compensation, one requires data from the affected region. Traditionally, this was done with on-the-ground measurements, such as moisture detectors and crop cuttings. However, operations to gather these measurements are hard to conduct at scale, and remote sensing techniques using satellite imagery have become more prevalent.</p>
<p>In this project, we take inspiration and a great dataset from the communal <a href="https://wandb.ai/wandb/droughtwatch/benchmark"><code>droughtwatch</code> benchmark</a> hosted by Weights and Biases. <strong>We seek to construct a deep learning model that can predict the forage quality of land based on satellite imagery, without the need for expensive ground-based survey campaigns</strong>. The model must take in as input satellite image data in several different bands and output the number of goats that could be supported at the area <em>in the center of the image</em>. For more background and information on the dataset, see <a href="https://arxiv.org/abs/2004.04081">here</a>.</p>
<p>We create an entire end-to-end pipeline to train, test, deploy and monitor such a model. The tech stack is briefly summarised here:</p>
<ul>
<li><a href="https://www.docker.com/">Docker</a> for containerisation</li>
<li><a href="https://airflow.apache.org/">Airflow</a> for training orchestration</li>
<li><a href="https://keras.io/">Keras</a>/<a href="https://onnx.ai/">ONNX</a> for training and building the model</li>
<li><a href="https://wandb.ai/site">Weights and Biases</a> or optionally <a href="https://mlflow.org/">MLFlow</a> for experimentation tracking and model registry</li>
<li><a href="https://aws.amazon.com/">AWS</a> StepFunctions/Lambda/RDS/ECR/S3/EventBridge for the batch inference pipeline</li>
<li><a href="https://www.evidentlyai.com/">Evidently AI</a>/<a href="https://grafana.com/">Grafana</a> for model observability</li>
<li><a href="https://www.terraform.io/">Terraform</a> for provisioning resources</li>
<li><a href="https://hydra.cc/">Hydra</a>/<a href="https://github.com/omry/omegaconf">OmegaConf</a> for project configuration</li>
<li><a href="https://www.mkdocs.org/">mkdocs</a> for documentation</li>
<li><a href="https://docs.pytest.org/en/stable/">pytest</a> for unit tests</li>
<li><a href="https://www.localstack.cloud/">Localstack</a> for inference integration tests</li>
</ul>
<h2 id="initial-setup">Initial setup</h2>
<p>This project assumes that one is using Linux/MacOS locally. If on Windows, please run inside WSL2.</p>
<p>In order to be able to execute this project, you will need:</p>
<ul>
<li>Python 3.10</li>
<li>Docker (v27.0 or later) with docker compose</li>
<li>Terraform (v1.9.3 or later)</li>
<li>aws cli==2.17.5</li>
<li>jq-1.6</li>
<li>GNU make (4.3 or later)</li>
</ul>
<p>You will also need an AWS account with sufficient privileges. Some resources will cost money; for a Free Tier account, this should be less than 1 USD.</p>
<p>To manage python dependencies, we use <a href="https://github.com/astral-sh/uv">uv</a> as it is extremely fast and robust. Install it following the <a href="https://github.com/astral-sh/uv?tab=readme-ov-file#getting-started">official guidelines</a>.</p>
<p>Throughout the project, <code>make</code> is used a lot. Note that whenever a <code>make</code> command is mentioned, it should be invoked at the top-level of the repo. To see the full list of possible commands, simply run
<div class="highlight"><pre><span></span><code>make
</code></pre></div></p>
<p>Setup the dev environment by running (this will use <code>uv</code> to create a new virtualenv and install all the necessary dependencies):</p>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>setup_env
</code></pre></div>
<p>You will need at least 14 GB of RAM and 40 GB of space.</p>
<p>Note that since we will be training CNNs, it is highly desirable to run on a machine with CUDA-capable GPU, or the training might take a very long time. For reference, the baseline model took about 5 minutes to train on an NVidia GTX 1060 6GB.</p>
<h3 id="building-the-documentation-optional">Building the documentation (optional)</h3>
<p>You can build and view a nicely rendered version of this document as well as additional documentation by simply running</p>
<div class="highlight"><pre><span></span><code><span class="nb">source</span><span class="w"> </span>.mlops/bin/activate
mkdocs<span class="w"> </span>serve<span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;localhost:7777&#39;</span>
</code></pre></div>
<p>and pointing your browser to <code>http://localhost:7777</code>.</p>
<h2 id="training-the-model">Training the model</h2>
<p>For a much more detailed description, see <a href="../training_pipeline/">here</a>.</p>
<h3 id="part-i-get-the-data">Part I: Get the data</h3>
<p>The training data is large and thus we only want to download it once. You can do this by running</p>
<p><div class="highlight"><pre><span></span><code><span class="nb">source</span><span class="w"> </span>.mlops/bin/activate
make<span class="w"> </span>download_data
</code></pre></div>
Note that this will take a few minutes.</p>
<h3 id="part-ii-prepare-the-infrastructure">Part II: Prepare the infrastructure</h3>
<p>The training pipeline is managed by <code>Airflow</code> DAGs, which takes care of data preparation and actual training using <code>Keras</code>. The experimentation tracking can either be done:</p>
<ul>
<li>locally with <code>MLFlow</code> or</li>
<li>on the Weights and Biases cloud. The latter requires one to have a WandB account (the free tier is more than sufficient). In particular, you will need your <code>WANDB_API_KEY</code> (see below).</li>
</ul>
<p>To do this, we run a docker compose stack that contains all the necessary services. In order for everything to work, one needs to configure a few things first. The configuration for this project is managed via Hydra, that uses nested, composable yaml files. These configuration files are in <code>./setup/conf</code>.</p>
<p>First, the user <em>must</em> set up a secrets file, which will contain the AWS (and optionally WandB credentials). This should be a file in standard <code>.env</code> format. Here is one example of how it can be created (assuming one is using WandB):</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>setup
<span class="nb">export</span><span class="w"> </span><span class="nv">WANDB_API_KEY</span><span class="o">=</span>XXXX
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;WANDB_API_KEY=</span><span class="si">${</span><span class="nv">WANDB_API_KEY</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>.secrets

aws<span class="w"> </span>configure<span class="w"> </span>sso<span class="w"> </span><span class="c1"># If using SSO credentials</span>
aws<span class="w"> </span>configure<span class="w"> </span>export-credentials<span class="w"> </span>--format<span class="w"> </span>env-no-export<span class="w"> </span>&gt;&gt;<span class="w"> </span>.secrets
</code></pre></div>
<p>You should then have something like this in <code>.secrets</code></p>
<div class="highlight"><pre><span></span><code><span class="nv">WANDB_API_KEY</span><span class="o">=</span>XXXX
<span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>YYYYYYYYY
<span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>ZZZZZZZZZZZZZZZZ
<span class="nv">AWS_SESSION_TOKEN</span><span class="o">=</span>REALLY_LONG_STRING
<span class="nv">AWS_CREDENTIAL_EXPIRATION</span><span class="o">=</span><span class="m">2024</span>-07-24T13:36:28+00:00
</code></pre></div>
<p>You can then change the values in <code>./setup/conf/config.yaml</code>. Most importantly:</p>
<ul>
<li><code>training.model_registry_s3_bucket</code>: Name of the S3 bucket that will be created to store models that are promoted to the model registry. <strong>Make sure to pick a globally unique name</strong> (using <code>uuidgen</code> may be helpful here).</li>
<li><code>training.logging.style</code>: This determines whether the experiment tracking is done using WandB in the cloud or locally using MLFlow (note that this means the tracking and backend server are local, i.e. inside the docker stack, while models in the registry will still be written to S3). Can either be <code>wandb</code> or <code>mlflow</code>.</li>
<li><code>training.logging.wandb_org_name</code>: Name of the org created when setting up WandB. Only change this if WandB is used, otherwise leave the default. <strong>Note: you have to add <code>-org</code> to the end for the model registry to work</strong>. Thus, if you have an organization name <code>fantastic_cats</code>, this name should be <code>fantastic_cats-org</code>.</li>
<li><code>infra.aws_region</code>: The region in which all AWS services will be deployed.</li>
<li><code>infra.training.use_gpu_training</code>: Whether a GPU will be used (0 means no, 1 means yes). Note that only nVidia GPUs with compute capabilities &gt; 6 are supported. You will also need to set up the nvidia Docker toolkit, as described <a href="../Docker_GPU/">here</a>.</li>
<li><code>infra.inference.data_bucket</code>: The name of the bucket where new data will be added to run batch inference.</li>
<li><code>model_path</code>: Which model in the <code>model_registry_s3_bucket</code> to use. WARNING: only change this if you intend to train more than just the default baseline model.</li>
</ul>
<p>Once all done, deploy the training infrastructure docker by doing:</p>
<p><div class="highlight"><pre><span></span><code>make<span class="w"> </span>setup_training_infra
</code></pre></div>
This will produce a lot of output, including a yaml representation of the project configuration. It will also
setup the s3 bucket needed to hold models that will be promoted to the model registry.</p>
<p>If everything looks right and no errors are returned, deploy everything by running</p>
<p><div class="highlight"><pre><span></span><code>make<span class="w"> </span>launch_training_infra
</code></pre></div>
This will take a while the first time you run it, as it will be necessary to pull and build the images. This may take a while (5-10 minutes depending on your internet connection). Check that you can access the <code>Airflow</code> server at <code>http://localhost:8080</code> (it might take 2 minutes or so for the webserver to spin up). You can log in with the default password (<code>admin:admin</code>). You should see several DAGs.</p>
<p>You are now all set to do the training!</p>
<h3 id="part-iii-training">Part III: Training</h3>
<p>To train the most basic model, simply do</p>
<p><div class="highlight"><pre><span></span><code>make<span class="w"> </span>train_baseline
</code></pre></div>
This will trigger the <code>baseline</code> dag (you may have to reload the Airflow UI webpage to see the progress).
Note that the first time you trigger this, it will start by pre-processing the image data (filtering and feature engineering). Since there is a lot of data (&gt;100k images) this may take a few minutes (~10). Once the <code>data_processing</code> task is done, you should be able to see the training progress either on <code>MLFlow</code>(point your browser to <code>localhost:5012</code>) or <code>wandb</code>.
If using <code>wandb</code>, you should also see the run appear under <code>USERNAME/droughtwatch_capstone</code> project. It should take 5 minutes to train on the GPU. You should see the standard metrics like training and validation accuracy and loss, as well as others. (Note that by default the training is set to go for only 2 epochs. To change this behaviour, change the <code>config.yaml</code> file to  override <code>training.model.epochs</code>.)</p>
<p>The DAG is configured to run every 24 hours to retrain the model in case new data is added.</p>
<p>At the end of this training, the model and all parameters and metrics are logged, and:</p>
<ul>
<li>the model is uploaded to s3</li>
<li>the model is promoted to the model registry</li>
</ul>
<p>This is in principle all one needs to do in order to proceed with model deployment. However, you can also train a few more interesting models if you wish:</p>
<ul>
<li><code>useful</code>- just like baseline but with 100 epochs and thus much better accuracy</li>
<li><code>ndvi</code> - uses NDVI as the feature instead of the RGB+NIR bands</li>
</ul>
<p>You can easily add your own or extend the feature set by adding to the file <code>./training/airflow/dags/pipeline.py</code>.
See in particular how one can easily override the feature list <a href="https://github.com/SergeiOssokine/droughtwatch_capstone/blob/main/training/airflow/dags/pipeline.py#L47">here</a></p>
<p>When you are done with training, clean up by running:</p>
<p><div class="highlight"><pre><span></span><code>make<span class="w"> </span>clean_up_training
</code></pre></div>
This will bring down all the docker containers we have deployed.</p>
<h2 id="inference">Inference</h2>
<h3 id="part-i-setting-up-the-infrastructure">Part I: Setting up the infrastructure</h3>
<p>The inference pipeline (shown below) is hosted on AWS and is provisioned using terraform. In brief, the pipeline is orchestrated using AWS StepFunctions, which in this case just means it executes 3 AWS Lambda functions which correspond to processing the data, running the model on the processed data, and finally computing some metrics on the predictions. To trigger the pipeline, we use an EventBridge scheduler that simply runs the StepFunctions every 24 hours (or whatever cadence we configure). For a much more detailed description, see <a href="../inference_pipeline/">here</a>.</p>
<p>First thing to do is to configure the infrastructure for inference. To do so, run</p>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>setup_inference_infra
</code></pre></div>
<p>This will perform the following actions:</p>
<ol>
<li>Read the overall configuration (from <code>setup/conf</code>)</li>
<li>Populate the terraform variables based on this config (in <code>inference/setup/tf/vars/droughtwatch.tfvars</code>)</li>
<li>Build the image for the Lambda functions that will do all the work, and push the image to a private ECR repo. Note that this step may take a while (~5-10 minutes) depending on your internet connection. (Note: sometimes it may complain and give a timeout error; just rerun the make command and try again.)</li>
</ol>
<p>Next, one requires to set up a new ssh keypair which will allow local access to the RDS database on AWS while being secure.</p>
<p><div class="highlight"><pre><span></span><code>cd inference/setup/tf/modules/ec2
ssh-keygen  -t ed25519
</code></pre></div>
Select <code>./id_ed25519</code> to be the path and you can leave the passphrase blank.</p>
<p>Now we are ready to provision the infrastructure. Navigate to the top-level of the repo and run</p>
<p><div class="highlight"><pre><span></span><code>make<span class="w"> </span>provision_inference_infra
</code></pre></div>
This will launch the terraform process which will ask you to enter several things:</p>
<ol>
<li>
<p>First it will ask for the name of the <em>public</em> key. If you have been following the guide, you can simply type in <code>id_ed25519.pub</code>.</p>
</li>
<li>
<p>It will then ask for a password that you would like to use for the database. <strong>Make sure the password you enter is at least 8 characters long!</strong> Don't forget this!</p>
</li>
<li>
<p>Lastly it will ask for a username for the database. Don't forget this either!</p>
</li>
</ol>
<p>You will then need to type in "yes" to confirm the deployment with terraform, and the provisioning will begin. It should take about 5 minutes to provision everything.</p>
<p>To be able to visualize metrics in a nice grafana dashboard, two more short steps are needed: first connect to the bastion host, to generate an ssh tunnel that allows our local machine to access the database. This can be done by running (replace with the actual path!):</p>
<p><div class="highlight"><pre><span></span><code>bash<span class="w"> </span>inference/observability/create_rds_tunnel.sh<span class="w"> </span>/path/to/your/PRIVATE/key
</code></pre></div>
(If you have been following the guide exactly, this path would be <code>inference/setup/tf/modules/ec2/id_ed25519</code>.)</p>
<p>This will produce a command that looks like the following
<div class="highlight"><pre><span></span><code>ssh -i /home/sergei/.ssh/id_ed25519 ubuntu@i-0be7a30f923f2d693 -o ServerAliveInterval=30 -o ProxyCommand=&#39;aws ec2-instance-connect open-tunnel --instance-id i-0be7a30f923f2d693&#39; -L 5432:droughtwatch.cbesic40wlrm.us-east-1.rds.amazonaws.com:5432
</code></pre></div>
Open another terminal window and execute this command to create the ssh tunnel.
Finally run (note that the the database name, unless it was changed in the config, should be <code>droughtwatch</code>):</p>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>setup_inference_observability
</code></pre></div>
<p>This will do the following:</p>
<ol>
<li>Launch a docker container running grafana</li>
<li>Use terraform to provision a dashboard on this grafana instance. Terraform will ask for the same database username and password again.</li>
</ol>
<p>That's it!</p>
<h3 id="part-ii-running-inference-and-observability">Part II: Running inference and observability</h3>
<p>First we need to upload some data to s3 for our model to ingest. While 24 hours is a reasonable cadence for real-world scenarios with satellite data, for demonstration purposes we don't want to wait that long. Thus we provide a script that:</p>
<ul>
<li>Uploads a new set of data every 20 seconds for a total of 15 datasets</li>
<li>Runs the inference pipeline on it (and blocks until each run is finished)</li>
</ul>
<p>You can launch the script by running:</p>
<p><div class="highlight"><pre><span></span><code>make<span class="w"> </span>upload_and_run_inference
</code></pre></div>
Then you can monitor the progress in a variety of ways:</p>
<ol>
<li>On AWS CloudConsole, in StepFunctions</li>
<li>Navigating to <code>localhost:3000</code> to grafana and login in with the default credentials <code>admin:admin</code>. (You can skip setting a new password.) Then go to <code>Dashboards</code> and you will see live metrics being updated.</li>
</ol>
<p>You can of course upload more data to the data bucket and trigger the StepFunction with the AWS UI or from the cli.</p>
<p>Once you are done experimenting, clean up the infrastructure by running:
<strong>WARNING: this will delete all provisioned resources, including the S3 bucket which has the model and the ECR repository.</strong></p>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>clean_up_infra
</code></pre></div>
<p>At a couple of points you will have to enter the same info you did when you created the terraform resources. Note that the last step involves destroying things provisioned on AWS and it may take up to 25 minutes (!). More explanation on why it takes this long can be found <a href="https://github.com/hashicorp/terraform-provider-aws/issues/31520">here</a>.  <strong>Note: If you wish to delete the CloudWatch logs too, you will have to delete them manually as they weren't provisioned with Terraform.</strong></p>
<h2 id="testing">Testing</h2>
<h3 id="unit-tests">Unit tests</h3>
<p>The unit tests perform some minor checks and can be run with:</p>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>unit_tests
</code></pre></div>
<h3 id="integration-test">Integration test</h3>
<p>The integration test will test the three most important components of the inference pipeline, namely the three Lambda functions. For a detailed description, see <a href="../inference_pipeline/">here</a>. This is done by spinning up <code>localstack</code> to emulate <code>S3</code> and <code>secretsmanager</code> as well as:</p>
<ul>
<li>3 containers representing the 3 Lambdas</li>
<li>a postgres database container</li>
</ul>
<p>The test then runs the Lambdas inside the container and checks that they perform as expected. In particular, for the <code>processing</code> and <code>inference</code> Lambdas, it checks that the functions create the appropriate result files with expected sizes. For the <code>observe</code> Lambda, it checks that the database contains a metrics table with the expected metrics.</p>
<p>To run the integration test, do:</p>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>integration_tests
</code></pre></div>
<h3 id="cicd">CI/CD</h3>
<p>Github Actions are set up to run the unit and integration tests on every merge request to the main branch.</p>
<h2 id="code-quality">Code quality</h2>
<p>The project is configured to run several different checks on every commit via <code>pre-commit</code>. One can also run a more extensive check by doing:</p>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>quality_check
</code></pre></div>
<p>This will run <code>black</code> and <code>isort</code> for formatting as well as <code>pylint</code> for linting.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
    
  </body>
</html>